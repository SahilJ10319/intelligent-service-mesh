<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeuraGate â€” Live Operations Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0e1a;
      --surface:   #111827;
      --surface2:  #1a2235;
      --border:    #1e2d45;
      --accent:    #3b82f6;
      --accent2:   #8b5cf6;
      --green:     #10b981;
      --yellow:    #f59e0b;
      --red:       #ef4444;
      --text:      #e2e8f0;
      --muted:     #64748b;
      --font:      'Inter', sans-serif;
      --mono:      'JetBrains Mono', monospace;
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); font-size: 14px; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .shell { display: grid; grid-template-rows: 56px 1fr; height: 100vh; }

    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; background: var(--surface); border-bottom: 1px solid var(--border);
    }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 16px; }
    .logo-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }

    .header-right { display: flex; align-items: center; gap: 16px; }
    .badge { padding: 3px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; letter-spacing:.5px; }
    .badge-live { background: rgba(16,185,129,.15); color: var(--green); border: 1px solid rgba(16,185,129,.3); }
    .badge-ai   { background: rgba(139,92,246,.15);  color: var(--accent2); border: 1px solid rgba(139,92,246,.3); }
    #conn-count { font-size: 12px; color: var(--muted); }

    main { display: grid; grid-template-columns: 1fr 380px; grid-template-rows: auto 1fr; gap: 16px; padding: 16px; overflow: hidden; }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 20px; display: flex; flex-direction: column; gap: 12px;
    }
    .card-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }

    /* â”€â”€ Metric Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .metrics-grid { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }

    .metric-card {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px 18px; display: flex; flex-direction: column; gap: 6px;
      transition: border-color .3s;
    }
    .metric-card:hover { border-color: var(--accent); }
    .metric-label { font-size: 11px; color: var(--muted); font-weight: 500; }
    .metric-value { font-size: 28px; font-weight: 700; font-family: var(--mono); line-height: 1; }
    .metric-unit  { font-size: 11px; color: var(--muted); margin-top: 2px; }

    .val-green  { color: var(--green); }
    .val-yellow { color: var(--yellow); }
    .val-red    { color: var(--red); }
    .val-blue   { color: var(--accent); }
    .val-purple { color: var(--accent2); }

    /* â”€â”€ Request Feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .feed-card { overflow: hidden; }
    .feed-list { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 6px; max-height: calc(100vh - 260px); }
    .feed-list::-webkit-scrollbar { width: 4px; }
    .feed-list::-webkit-scrollbar-track { background: transparent; }
    .feed-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    .feed-row {
      display: grid; grid-template-columns: 60px 80px 1fr 60px 70px;
      align-items: center; gap: 8px; padding: 8px 10px;
      background: var(--surface2); border-radius: 8px; font-size: 12px;
      animation: slideIn .25s ease;
    }
    @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }

    .method { font-family: var(--mono); font-weight: 600; font-size: 11px; }
    .method-GET    { color: var(--green); }
    .method-POST   { color: var(--accent); }
    .method-PUT    { color: var(--yellow); }
    .method-DELETE { color: var(--red); }

    .status-pill { padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 700; text-align: center; }
    .s2xx { background: rgba(16,185,129,.15); color: var(--green); }
    .s4xx { background: rgba(245,158,11,.15);  color: var(--yellow); }
    .s5xx { background: rgba(239,68,68,.15);   color: var(--red); }

    .path { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: var(--mono); font-size: 11px; }
    .latency { font-family: var(--mono); text-align: right; }
    .ts { color: var(--muted); font-size: 10px; text-align: right; }

    /* â”€â”€ AI Decision Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ai-card { overflow: hidden; }
    .ai-list { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; max-height: calc(100vh - 260px); }
    .ai-list::-webkit-scrollbar { width: 4px; }
    .ai-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    .ai-entry {
      background: var(--surface2); border-radius: 8px; padding: 12px;
      border-left: 3px solid var(--accent2); display: flex; flex-direction: column; gap: 6px;
      animation: slideIn .25s ease;
    }
    .ai-entry.sev-HIGH     { border-left-color: var(--red); }
    .ai-entry.sev-MEDIUM   { border-left-color: var(--yellow); }
    .ai-entry.sev-LOW      { border-left-color: var(--green); }
    .ai-entry.sev-CRITICAL { border-left-color: #ff0055; }
    .ai-entry.sev-NORMAL   { border-left-color: var(--muted); }

    .ai-header { display: flex; align-items: center; justify-content: space-between; }
    .ai-sev { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 999px; }
    .sev-HIGH     { background: rgba(239,68,68,.15);   color: var(--red); }
    .sev-MEDIUM   { background: rgba(245,158,11,.15);  color: var(--yellow); }
    .sev-LOW      { background: rgba(16,185,129,.15);  color: var(--green); }
    .sev-CRITICAL { background: rgba(255,0,85,.15);    color: #ff0055; }
    .sev-NORMAL   { background: rgba(100,116,139,.15); color: var(--muted); }

    .ai-conf { font-size: 11px; color: var(--muted); font-family: var(--mono); }
    .ai-diagnosis { font-size: 12px; font-weight: 500; }
    .ai-action { font-size: 11px; color: var(--muted); line-height: 1.5; }
    .ai-ts { font-size: 10px; color: var(--muted); }

    /* â”€â”€ Confidence Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .conf-bar { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .conf-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 2px; transition: width .5s ease; }

    /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty { color: var(--muted); font-size: 12px; text-align: center; padding: 24px 0; }
  </style>
</head>
<body>
<div class="shell">

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <div class="logo">
      <div class="logo-dot"></div>
      NeuraGate Operations
    </div>
    <div class="header-right">
      <span class="badge badge-live">â— LIVE</span>
      <span class="badge badge-ai">ğŸ¤– AI ACTIVE</span>
      <span id="conn-count">Connectingâ€¦</span>
    </div>
  </header>

  <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main>

    <!-- Metric Cards -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">Avg Latency</div>
        <div class="metric-value val-blue" id="m-latency">â€”</div>
        <div class="metric-unit">milliseconds</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Error Rate</div>
        <div class="metric-value" id="m-error-rate">â€”</div>
        <div class="metric-unit">percent</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">2xx OK</div>
        <div class="metric-value val-green" id="m-2xx">â€”</div>
        <div class="metric-unit">responses</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">4xx Errors</div>
        <div class="metric-value val-yellow" id="m-4xx">â€”</div>
        <div class="metric-unit">responses</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">5xx Errors</div>
        <div class="metric-value val-red" id="m-5xx">â€”</div>
        <div class="metric-unit">responses</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Buffer Fill</div>
        <div class="metric-value val-purple" id="m-buf">â€”</div>
        <div class="metric-unit">% utilization</div>
      </div>
    </div>

    <!-- Request Feed -->
    <div class="card feed-card">
      <div class="card-title">Live Request Feed</div>
      <div class="feed-list" id="feed-list">
        <div class="empty">Waiting for trafficâ€¦</div>
      </div>
    </div>

    <!-- AI Decision Log -->
    <div class="card ai-card">
      <div class="card-title">AI Decision Log</div>
      <div class="ai-list" id="ai-list">
        <div class="empty">Waiting for AI analysisâ€¦</div>
      </div>
    </div>

  </main>
</div>

<script>
  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $ = id => document.getElementById(id);
  const MAX_FEED = 80;
  const MAX_AI   = 30;

  function fmtTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleTimeString('en-GB', { hour12: false });
  }

  function latencyClass(ms) {
    if (ms < 100) return 'val-green';
    if (ms < 300) return 'val-blue';
    if (ms < 600) return 'val-yellow';
    return 'val-red';
  }

  function errorRateClass(rate) {
    if (rate < 2)  return 'val-green';
    if (rate < 10) return 'val-yellow';
    return 'val-red';
  }

  function statusClass(code) {
    if (code >= 500) return 's5xx';
    if (code >= 400) return 's4xx';
    return 's2xx';
  }

  function methodClass(m) { return 'method-' + (m || 'GET'); }

  function prependRow(list, el, max) {
    const empty = list.querySelector('.empty');
    if (empty) empty.remove();
    list.prepend(el);
    while (list.children.length > max) list.removeChild(list.lastChild);
  }

  // â”€â”€ Metrics snapshot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applySnapshot(d) {
    const lat = parseFloat(d.avgLatency || 0).toFixed(1);
    const err = parseFloat(d.errorRate  || 0).toFixed(2);
    const buf = parseFloat(d.bufferUtilization || 0).toFixed(1);

    $('m-latency').textContent = lat;
    $('m-latency').className   = 'metric-value ' + latencyClass(parseFloat(lat));

    $('m-error-rate').textContent = err;
    $('m-error-rate').className   = 'metric-value ' + errorRateClass(parseFloat(err));

    $('m-2xx').textContent = d.count2xx ?? 'â€”';
    $('m-4xx').textContent = d.count4xx ?? 'â€”';
    $('m-5xx').textContent = d.count5xx ?? 'â€”';
    $('m-buf').textContent = buf;
  }

  // â”€â”€ Telemetry row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addFeedRow(t) {
    const row = document.createElement('div');
    row.className = 'feed-row';
    row.innerHTML = `
      <span class="method ${methodClass(t.method)}">${t.method || 'GET'}</span>
      <span class="status-pill ${statusClass(t.status)}">${t.status || 0}</span>
      <span class="path" title="${t.path}">${t.path || '/'}</span>
      <span class="latency ${latencyClass(t.latency)}">${t.latency}ms</span>
      <span class="ts">${fmtTime(t.timestamp)}</span>
    `;
    prependRow($('feed-list'), row, MAX_FEED);
  }

  // â”€â”€ AI decision entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addAiEntry(d) {
    const sev = (d.severity || 'NORMAL').toUpperCase();
    const conf = parseInt(d.confidence || 0);
    const entry = document.createElement('div');
    entry.className = `ai-entry sev-${sev}`;
    entry.innerHTML = `
      <div class="ai-header">
        <span class="ai-sev sev-${sev}">${sev}</span>
        <span class="ai-conf">${conf}% confidence</span>
      </div>
      <div class="conf-bar"><div class="conf-fill" style="width:${conf}%"></div></div>
      <div class="ai-diagnosis">${d.diagnosis || 'Analysis complete'}</div>
      <div class="ai-action">â†’ ${d.action || d.suggestedAction || 'No action required'}</div>
      <div class="ai-ts">${fmtTime(d.timestamp)}</div>
    `;
    prependRow($('ai-list'), entry, MAX_AI);
  }

  // â”€â”€ SSE connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function connect() {
    const es = new EventSource('/dashboard/stream');

    es.addEventListener('metrics_snapshot', e => {
      try { applySnapshot(JSON.parse(e.data)); } catch(_) {}
    });

    es.addEventListener('telemetry', e => {
      try { addFeedRow(JSON.parse(e.data)); } catch(_) {}
    });

    es.addEventListener('ai_decision', e => {
      try { addAiEntry(JSON.parse(e.data)); } catch(_) {}
    });

    es.onopen  = () => { $('conn-count').textContent = 'SSE connected'; };
    es.onerror = () => { $('conn-count').textContent = 'Reconnectingâ€¦'; };
  }

  // â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  connect();

  // Poll /dashboard/metrics every 5 s as fallback
  setInterval(async () => {
    try {
      const r = await fetch('/dashboard/metrics');
      if (r.ok) applySnapshot(await r.json());
    } catch(_) {}
  }, 5000);

  // Poll /dashboard/ai-log every 15 s to seed AI log on load
  async function loadAiLog() {
    try {
      const r = await fetch('/dashboard/ai-log');
      if (!r.ok) return;
      const data = await r.json();
      if (data.latestAnalysis) addAiEntry({
        ...data.latestAnalysis,
        action: data.latestAnalysis.suggestedAction
      });
    } catch(_) {}
  }
  loadAiLog();
  setInterval(loadAiLog, 15000);
</script>
</body>
</html>
